# 2025-03-05

## SDF CAD

So the plan today is to add a "document tree" to this, and then add ways to insert
primitives, modifiers, and combinators into the tree, and render the tree into GLSL
for drawing on the screen.

Primitives:

 * box
 * sphere
 * torus

Modifiers:

 * translate
 * rotate
 * scale
 * thickness
 * elongate
 * renormalise

Combinators:

 * union
 * intersection
 * difference

And see Inigo Quilez's website for more, and for shader implementations.

I'm actually having more difficulty than expected in turning my tree representation
into GLSL code.

The first attempt was to have the `generateShaderCode()` function return a single
expression, and have `shaderImplementation()` return code for supporting functions that
only wants to appear once.

So for example the Sphere `generateShaderCode()` would be `sdSphere(p, ${radius})`.
And a combinator would result in code like `opUnion(sdSphere(p, 1.0), sdSphere(p, 2.0))`
or whatever.

But then the problem is that we can't modify `p`. So we're propagating function
call code up the tree, do we need to be propagating `p` modifications *down* the tree?
But will that result in re-evaluating the modifications over and over again?

Or do we use `shaderImplementation()` to provide helper functions for every modifier?
Maybe that's the way! Just need to give them unique names. That seems to be working!

https://img.incoherency.co.uk/6005

Now with:

 * runs out of filesystem instead of requiring server
 * FPS counter (not pictured)
 * orthographic projection
 * internal tree representation of scene

Next up:

 * bring back smooth stepping for combinators
 * tree editor
 * export mesh
 * FreeCAD-like "transform" tool for positioning things in space
 * more primitives, modifiers, combinators
 * some support for custom SDF functions?

Somehow it keeps crashing Firefox. I keep getting back to the computer to find
Firefox has closed.

One issue is it recomputes the shader every frame even if nothing has changed.
Worry about that later.

I'm giving the tree nodes a function `properties()` that returns a map of property name
to type (currently just "vec3" and "float"). And then `getProperty()` and `setProperty()`
should be used to get/set, default to just writing into the object, but can be
overridden by each node.

So then we want a tree view, a property editor, and some way to add/remove
nodes in the tree. And that's a CAD MVP.

Whoa, Cursor's first attempt basically works straight away, modulo UI jank.

https://img.incoherency.co.uk/6006

It functions, it just needs to be more user-friendly.

Now with editable "displayName", icons for different operations, lines connecting up
the tree, resizable panel.

https://img.incoherency.co.uk/6007

Can now delete a node, with a context menu.

Can add primitives with the context menu.

Can add modifiers/combinators with the context menu.

Can unlink a node so that its children become direct children of its parent.

Can disable edge detection in shader, and the edge highlight size is now fixed in screen
space instead of object space.

Still todo:

 * temporarily show a subtree on its own but in a different colour (duplicate the subtree and union it with the document, but what about colour?) - maybe automatically on hover/select?
 * temporarily change the display to show only a subtree (generate shader from that subtree instead of from root)
 * temporarily disable a subtree so I can see what it would be like deleted (add a flag to hide a subtree, makes it generate a no-op SDF)
 * change a modifier to a different type of modifier
 * insert a modifier/combinator between multiple existing sibling nodes and their common parent
 * add a new top-level modifier/combinator
 * reorder the nodes to suit my personal preference
 * drag-and-drop nodes to other places (highlight the "path" to the root at the point it would drop, let the horizontal coordinate of the mouse suggest which node to attach to)
 * a way for a tree node to signal warning/error conditions and show them in the tree view, also to signal non-Euclidianness
 * isomorphism between tree view and editable text
 * validation on property editing
 * when you select any object it should show its local coordinate directions on the screen as a RGB 3-axis view, and when you click in a vec3 editor it should subdue the 2 axes that you're not editing, also maybe put a border around the 3 boxes in red/green/blue
 * save/load your work
 * export mesh
 * fix glitches on larger objects
 * make reusable objects that become their own opaque nodes for "assemblies" etc.
 * sketches
 * make rotation/pan/zoom work better


